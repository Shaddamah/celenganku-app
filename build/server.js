(()=>{"use strict";var e={n:t=>{var r=t&&t.__esModule?()=>t.default:()=>t;return e.d(r,{a:r}),r},d:(t,r)=>{for(var n in r)e.o(r,n)&&!e.o(t,n)&&Object.defineProperty(t,n,{enumerable:!0,get:r[n]})},o:(e,t)=>Object.prototype.hasOwnProperty.call(e,t)};require("regenerator-runtime");const t=require("express");var r=e.n(t);const n=require("path");var s=e.n(n);const o=require("body-parser");var a=e.n(o);const u=require("cors");var i=e.n(u);const c=require("helmet");var p=e.n(c);const l=require("hpp");var d=e.n(l);const f=require("xss-clean");var m=e.n(f);const b=require("cookie-parser");var g=e.n(b);function y(e){return(y="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function v(e,t){return!t||"object"!==y(t)&&"function"!=typeof t?function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e):t}function w(e){var t="function"==typeof Map?new Map:void 0;return(w=function(e){if(null===e||(r=e,-1===Function.toString.call(r).indexOf("[native code]")))return e;var r;if("function"!=typeof e)throw new TypeError("Super expression must either be null or a function");if(void 0!==t){if(t.has(e))return t.get(e);t.set(e,n)}function n(){return h(e,arguments,k(this).constructor)}return n.prototype=Object.create(e.prototype,{constructor:{value:n,enumerable:!1,writable:!0,configurable:!0}}),O(n,e)})(e)}function h(e,t,r){return(h=j()?Reflect.construct:function(e,t,r){var n=[null];n.push.apply(n,t);var s=new(Function.bind.apply(e,n));return r&&O(s,r.prototype),s}).apply(null,arguments)}function j(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(e){return!1}}function O(e,t){return(O=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function k(e){return(k=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}Error;function x(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),r.push.apply(r,n)}return r}function P(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{};t%2?x(Object(r),!0).forEach((function(t){_(e,t,r[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):x(Object(r)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))}))}return e}function _(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function S(e,t,r,n,s,o,a){try{var u=e[o](a),i=u.value}catch(e){return void r(e)}u.done?t(i):Promise.resolve(i).then(n,s)}function A(e){return function(){var t=this,r=arguments;return new Promise((function(n,s){var o=e.apply(t,r);function a(e){S(o,n,s,a,u,"next",e)}function u(e){S(o,n,s,a,u,"throw",e)}a(void 0)}))}}const R=function(){for(var e=arguments.length,t=new Array(e),r=0;r<e;r++)t[r]=arguments[r];return function(){var e=A(regeneratorRuntime.mark((function e(r,n,s){return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:try{t.forEach(function(){var e=A(regeneratorRuntime.mark((function e(t){return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,t.doc(r.params.id).delete();case 2:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}()),n.status(200).json({status:"success",error:!1,results:"Deleted ".concat(t.length," document")})}catch(e){n.status(502).json({status:"success",error:!0,response:e})}case 1:case"end":return e.stop()}}),e)})));return function(t,r,n){return e.apply(this,arguments)}}()},D=function(e){return function(){var t=A(regeneratorRuntime.mark((function t(r,n,s){var o,a;return regeneratorRuntime.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.prev=0,t.next=3,e.doc(r.params.id).get();case 3:if((o=t.sent).exists){t.next=7;break}return n.status(401).json({status:"failed",error:!0,message:"No document found with that id",response:r.params}),t.abrupt("return",{success:!1});case 7:return a=o.data(),n.status(200).json(P({status:"success",error:!1},a)),t.abrupt("return",{success:!0});case 12:t.prev=12,t.t0=t.catch(0),n.status(502).json({status:"success",error:!0,response:t.t0});case 15:case"end":return t.stop()}}),t,null,[[0,12]])})));return function(e,r,n){return t.apply(this,arguments)}}()},E=function(e){return function(){var t=A(regeneratorRuntime.mark((function t(r,n,s){var o;return regeneratorRuntime.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.prev=0,o=[],t.next=4,e.get();case 4:if(t.sent.forEach((function(e){o.push(e.data())})),n.status(200).json(P({status:"success",error:!1,results:o.length},o)),!(o.length>0)){t.next=9;break}return t.abrupt("return",{success:!0});case 9:return t.abrupt("return",{success:!1});case 12:t.prev=12,t.t0=t.catch(0),n.status(502).json({status:"success",error:!0,response:t.t0});case 15:case"end":return t.stop()}}),t,null,[[0,12]])})));return function(e,r,n){return t.apply(this,arguments)}}()},I=require("firebase/app");var q=e.n(I);require("firebase/firestore");const N=q().initializeApp({apiKey:"AIzaSyAW4XYKvHlGB2n85IrI311kXrFp-S_11YM",authDomain:"celenganku-app.firebaseapp.com",databaseURL:"https://celenganku-app.firebaseio.com",projectId:"celenganku-app",storageBucket:"celenganku-app.appspot.com",messagingSenderId:"414105942761",appId:"1:414105942761:web:f68bc17372af32cf848e78",measurementId:"G-QQ3YEP9ZCT"}).firestore(),T={data:N.collection("data_siswa"),akun:N.collection("akun_siswa"),profil:N.collection("profil_siswa")};function C(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),r.push.apply(r,n)}return r}function M(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{};t%2?C(Object(r),!0).forEach((function(t){F(e,t,r[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):C(Object(r)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))}))}return e}function F(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function K(e,t,r,n,s,o,a){try{var u=e[o](a),i=u.value}catch(e){return void r(e)}u.done?t(i):Promise.resolve(i).then(n,s)}function L(e){return function(){var t=this,r=arguments;return new Promise((function(n,s){var o=e.apply(t,r);function a(e){K(o,n,s,a,u,"next",e)}function u(e){K(o,n,s,a,u,"throw",e)}a(void 0)}))}}var Y,B;const X={getAllSiswaData:E(T.data),getAllAkunSiswa:E(T.akun),getDataSiswa:D(T.data),getProfilSiswa:D(T.profil),getAkunSiswa:D(T.akun),deleteAkunSiswa:R(T.akun,T.profil),createAkunSiswa:(B=L(regeneratorRuntime.mark((function e(t,r,n){var s,o,a,u,i,c;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(e.prev=0,s=t.body,o=s.nisn,a=s.email,u=s.password,i=s.no_telepon,c=s.url_foto,o&&a&&u){e.next=4;break}return e.abrupt("return",r.status(404).json({status:"failed",error:!0,message:"Please provide NISN, Email, or password",response:t.body}));case 4:return e.next=6,T.data.doc(o).get();case 6:return e.sent.exists||r.status(401).json({status:"failed",error:!0,message:"This NISN isn't registered",response:t.body}),e.next=10,T.akun.doc(o).get();case 10:return e.sent.exists&&r.status(401).json({status:"failed",error:!0,message:"Account with this NISN already exist",response:t.body}),e.next=14,T.akun.doc(o).set({nisn:o,email:a,password:u,saldo:0});case 14:return e.next=16,T.profil.doc(o).set({nisn:o,no_telepon:i||"",url_foto:c||""});case 16:return t.body.password=void 0,r.status(200).json({status:"success",error:!1,response:t.body}),e.abrupt("return",M(M({},t.body),{},{error:!1}));case 21:e.prev=21,e.t0=e.catch(0),console.log(e.t0),r.status(502).json({status:"success",error:!0,response:e.t0});case 25:case"end":return e.stop()}}),e,null,[[0,21]])}))),function(e,t,r){return B.apply(this,arguments)}),updateAkunSiswa:(Y=L(regeneratorRuntime.mark((function e(t,r,n){var s,o,a,u;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,s=t.params.id,e.next=4,T.akun.doc(s).get();case 4:return(o=e.sent).exists||r.status(401).json({status:"failed",error:!0,message:"Account with this NISN doesn't exist",response:t.body}),a=o.data(),u={email:t.body.email||a.email,password:t.body.password||a.password,no_telepon:t.body.no_telepon||a.no_telepon,url_foto:t.body.url_foto||a.url_foto},e.next=10,T.akun.doc(s).update({email:u.email,password:u.password});case 10:return e.next=12,T.profil.doc(s).set({no_telepon:u.no_telepon||"",url_foto:u.url_foto||""});case 12:return t.body.password=void 0,r.status(200).json({status:"success",error:!1,response:t.body}),e.abrupt("return",{success:!0});case 17:e.prev=17,e.t0=e.catch(0),console.log(e.t0),r.status(502).json({status:"failed",error:!0,response:e.t0});case 21:case"end":return e.stop()}}),e,null,[[0,17]])}))),function(e,t,r){return Y.apply(this,arguments)})},z=require("dotenv");var G=e.n(z);const Q=require("jsonwebtoken");var W=e.n(Q);function H(e,t,r,n,s,o,a){try{var u=e[o](a),i=u.value}catch(e){return void r(e)}u.done?t(i):Promise.resolve(i).then(n,s)}function U(e){return function(){var t=this,r=arguments;return new Promise((function(n,s){var o=e.apply(t,r);function a(e){H(o,n,s,a,u,"next",e)}function u(e){H(o,n,s,a,u,"throw",e)}a(void 0)}))}}G().config();var Z,J,V,$,ee=N.collection("akun_admin"),te=function(e){var t="user";return e.length<10&&(t="admin"),W().sign({id:e,role:t},process.env.ACCESS_TOKEN_SECRET,{expiresIn:process.env.ACCESS_EXPIRE_TIME})};const re={requireAuth:function(e,t,r){var n=e.cookies.jwt;n?W().verify(n,process.env.ACCESS_TOKEN_SECRET,(function(e,n){e?(console.log(e.message),t.redirect("/login")):r()})):t.redirect("/login")},restrictTo:function(){for(var e=arguments.length,t=new Array(e),r=0;r<e;r++)t[r]=arguments[r];return function(e,r,n){t.includes(e.user.role)||r.status(401).json({status:"failed",error:!0,message:"You're not allowed to do that action",response:e.body}),n()}},adminLogin:($=U(regeneratorRuntime.mark((function e(t,r,n){var s,o,a,u;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(e.prev=0,s=t.body,o=s.id_admin,a=s.password,o&&a){e.next=4;break}return e.abrupt("return",r.status(404).json({status:"failed",error:!0,message:"Please provide ID, or password",response:t.body}));case 4:return e.next=6,ee.where("id_admin","==",o).where("password","==",a).get();case 6:e.sent.empty&&r.status(401).json({status:"failed",error:!0,message:"Wrong ID or Password",response:t.body}),u=te(o),t.body.password=void 0,r.cookie("jwt",u,{httpOnly:!0,maxAge:2592e5}),r.status(200).json({status:"success",error:!1,response:t.body}),e.next=17;break;case 14:e.prev=14,e.t0=e.catch(0),n(e.t0);case 17:case"end":return e.stop()}}),e,null,[[0,14]])}))),function(e,t,r){return $.apply(this,arguments)}),login:(V=U(regeneratorRuntime.mark((function e(t,r,n){var s,o,a,u;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(e.prev=0,s=t.body,o=s.nisn,a=s.password,o&&a){e.next=4;break}return e.abrupt("return",r.status(404).json({status:"failed",error:!0,message:"Please provide NISN, or password",response:t.body}));case 4:return e.next=6,T.akun.where("nisn","==",o).where("password","==",a).get();case 6:e.sent.empty&&r.status(401).json({status:"error",error:!0,title:"NISN atau Password salah",message:"Silahkan coba lagi",response:t.body}),u=te(o),t.body.password=void 0,r.cookie("jwt",u,{httpOnly:!0,maxAge:2592e5}),r.status(200).json({status:"success",title:"Login Berhasil",message:"Mengalihkan ke halaman dashboard",error:!1,response:t.body}),e.next=17;break;case 14:e.prev=14,e.t0=e.catch(0),n(e.t0);case 17:case"end":return e.stop()}}),e,null,[[0,14]])}))),function(e,t,r){return V.apply(this,arguments)}),logout:function(e,t){t.cookie("jwt","",{maxAge:1}),t.redirect("/")},register:(J=U(regeneratorRuntime.mark((function e(t,r,n){var s,o,a;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,X.createAkunSiswa(t,r,n);case 2:s=e.sent,o=s.nisn,console.log(o),a=te(o),t.body.password=void 0,r.cookie("jwt",a,{httpOnly:!0,maxAge:2592e5}),r.status(200).json({status:"success",error:!1,response:t.body});case 9:case"end":return e.stop()}}),e)}))),function(e,t,r){return J.apply(this,arguments)}),retrieveToken:(Z=U(regeneratorRuntime.mark((function e(t,r,n){return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:r.status(200).json({status:"success",error:!1,response:t.cookies.jwt});case 1:case"end":return e.stop()}}),e)}))),function(e,t,r){return Z.apply(this,arguments)})};var ne=r().Router();ne.use(a().json()),ne.post("/register",re.register),ne.post("/login",re.login),ne.use(re.requireAuth),ne.route("/").get(X.getAllAkunSiswa),ne.route("/data").get(X.getDataSiswa),ne.route("/:id").get(X.getAkunSiswa).patch(X.updateAkunSiswa).delete(X.deleteAkunSiswa),ne.route("/:id/profil").get(X.getProfilSiswa),ne.route("/:id/data").get(X.getDataSiswa);const se=ne;function oe(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),r.push.apply(r,n)}return r}function ae(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{};t%2?oe(Object(r),!0).forEach((function(t){ue(e,t,r[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):oe(Object(r)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))}))}return e}function ue(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function ie(e,t,r,n,s,o,a){try{var u=e[o](a),i=u.value}catch(e){return void r(e)}u.done?t(i):Promise.resolve(i).then(n,s)}function ce(e){return function(){var t=this,r=arguments;return new Promise((function(n,s){var o=e.apply(t,r);function a(e){ie(o,n,s,a,u,"next",e)}function u(e){ie(o,n,s,a,u,"throw",e)}a(void 0)}))}}var pe,le,de=N.collection("akun_admin");const fe={getAdmin:D(T.akun),deleteAdmin:R(T.akun,T.profil),createAdmin:(le=ce(regeneratorRuntime.mark((function e(t,r,n){var s,o,a,u;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(e.prev=0,s=t.body,o=s.id_admin,a=s.nama,u=s.password,o&&a&&u){e.next=4;break}return e.abrupt("return",r.status(404).json({status:"failed",error:!0,message:"Please provide ID, Name, or password",response:t.body}));case 4:return e.next=6,de.doc(o).get();case 6:return e.sent.exists&&r.status(401).json({status:"failed",error:!0,message:"Account with this ID already exist",response:t.body}),e.next=10,de.akun.doc(o).set({id_admin:o,nama:a,password:u});case 10:return t.body.password=void 0,r.status(200).json({status:"success",error:!1,response:t.body}),e.abrupt("return",ae(ae({},t.body),{},{error:!1}));case 15:e.prev=15,e.t0=e.catch(0),console.log(e.t0),r.status(502).json({status:"success",error:!0,response:e.t0});case 19:case"end":return e.stop()}}),e,null,[[0,15]])}))),function(e,t,r){return le.apply(this,arguments)}),updateAdmin:(pe=ce(regeneratorRuntime.mark((function e(t,r,n){var s,o,a,u;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,s=t.params.id_admin,e.next=4,de.doc(s).get();case 4:if((o=e.sent).exists||r.status(401).json({status:"failed",error:!0,message:"Account with this ID doesn't exist",response:t.body}),a=o.data(),(u={id_admin:t.body.id_admin||a.id_admin,nama:t.body.nama||a.nama,password:t.body.password||a.password}).email&&u.password){e.next=10;break}return e.abrupt("return",r.status(404).json({status:"failed",error:!0,message:"Please provide Email, or password",response:t.body}));case 10:return e.next=12,de.doc(s).update({id_admin:u.id_admin,nama:u.nama,password:u.password});case 12:return t.body.password=void 0,r.status(200).json({status:"success",error:!1,response:t.body}),e.abrupt("return",{success:!0});case 17:e.prev=17,e.t0=e.catch(0),console.log(e.t0),r.status(502).json({status:"failed",error:!0,response:e.t0});case 21:case"end":return e.stop()}}),e,null,[[0,17]])}))),function(e,t,r){return pe.apply(this,arguments)})};var me=r().Router();me.use(a().json()),me.post("/login",re.adminLogin),me.use(re.requireAuth),me.route("/").get(fe.getAdmin),me.route("/:id").patch(fe.updateAdmin).delete(fe.deleteAdmin);const be=me;var ge=r()(),ye=s().join(__dirname,"index.html");ge.use(i()()),ge.use(p()()),ge.use(m()()),ge.use(d()()),ge.use(g()()),ge.use(r().json({limit:"15kb"})),ge.use("/api/siswa",se),ge.use("/api/admin",be),ge.get("/token",re.requireAuth,re.retrieveToken),ge.use("/logout",re.logout),ge.use(a().json()),ge.use(r().static(__dirname)),ge.use("/",(function(e,t){return t.sendFile(ye)}));const ve=ge,we={PORT:process.env.PORT||8080,DIST_DIR:__dirname};ve.listen(we.PORT,(function(){console.log("App listening to ".concat(we.PORT,"....")),console.log("Press Ctrl+C to quit.")}))})();