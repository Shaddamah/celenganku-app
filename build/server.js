(()=>{"use strict";var e={651:e=>{e.exports=require("xhr2")}},t={};function r(n){if(t[n])return t[n].exports;var s=t[n]={exports:{}};return e[n](s,s.exports,r),s.exports}r.n=e=>{var t=e&&e.__esModule?()=>e.default:()=>e;return r.d(t,{a:t}),t},r.d=(e,t)=>{for(var n in t)r.o(t,n)&&!r.o(e,n)&&Object.defineProperty(e,n,{enumerable:!0,get:t[n]})},r.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),(()=>{require("regenerator-runtime");const e=require("express");var t=r.n(e);const n=require("path");var s=r.n(n);const a=require("cors");var o=r.n(a);const u=require("body-parser");var i=r.n(u);const c=require("cookie-parser");var p=r.n(c);const d=require("multer");var l=r.n(d);const f=require("dotenv");var m=r.n(f);const g=require("bcrypt");var b=r.n(g);const y=require("jsonwebtoken");var h=r.n(y);const v=require("firebase/app");var w=r.n(v);require("firebase/firestore"),require("firebase/storage");var k=w().initializeApp({apiKey:"AIzaSyAW4XYKvHlGB2n85IrI311kXrFp-S_11YM",authDomain:"celenganku-app.firebaseapp.com",databaseURL:"https://celenganku-app.firebaseio.com",projectId:"celenganku-app",storageBucket:"celenganku-app.appspot.com",messagingSenderId:"414105942761",appId:"1:414105942761:web:f68bc17372af32cf848e78",measurementId:"G-QQ3YEP9ZCT"}),j=k.firestore(),x=k.storage();const O={data:j.collection("data_siswa"),akun:j.collection("akun_siswa"),profil:j.collection("profil_siswa")};function _(e,t,r,n,s,a,o){try{var u=e[a](o),i=u.value}catch(e){return void r(e)}u.done?t(i):Promise.resolve(i).then(n,s)}function S(e){return function(){var t=this,r=arguments;return new Promise((function(n,s){var a=e.apply(t,r);function o(e){_(a,n,s,o,u,"next",e)}function u(e){_(a,n,s,o,u,"throw",e)}o(void 0)}))}}global.XMLHttpRequest=r(651),m().config();var R,P,D,A,E,I=j.collection("akun_admin"),T=function(e){var t="user";return e.length<10&&(t="admin"),h().sign({id:e,role:t},process.env.ACCESS_TOKEN_SECRET,{expiresIn:process.env.ACCESS_EXPIRE_TIME})};const N={requireAuth:function(e,t,r){var n=e.cookies.jwt;n?h().verify(n,process.env.ACCESS_TOKEN_SECRET,(function(e,n){e?(console.log(e.message),t.redirect("/api/logout")):r()})):t.redirect("/api/logout")},restrictTo:function(){for(var e=arguments.length,t=new Array(e),r=0;r<e;r++)t[r]=arguments[r];return function(e,r,n){t.includes(e.user.role)||r.status(401).json({status:"failed",error:!0,message:"You're not allowed to do that action",response:e.body}),n()}},adminLogin:(E=S(regeneratorRuntime.mark((function e(t,r,n){var s,a,o,u,i,c;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(e.prev=0,s=t.body,a=s.id_admin,o=s.password,a&&o){e.next=4;break}return e.abrupt("return",r.status(404).json({status:"failed",error:!0,message:"Please provide ID, or password",response:t.body}));case 4:return e.next=6,I.doc(a).get();case 6:return(u=e.sent).empty&&r.status(401).json({status:"error",error:!0,title:"Login Gagal",message:"ID Admin atau Password salah",response:t.body}),(i=u.data()).password=i.password||"",""===i.password&&r.status(502).json({status:"error",error:!0,title:"Login Gagal",message:"ID Admin atau Password salah",response:t.body}),e.next=13,b().compare(o,i.password);case 13:e.sent?(c=T(a),t.body.password=void 0,r.cookie("jwt",c,{httpOnly:!0,maxAge:2592e6}),r.status(200).json({status:"success",title:"Login Berhasil",message:"Mengalihkan ke halaman dashboard",error:!1,response:t.body})):r.status(502).json({status:"error",error:!0,title:"Login Gagal",message:"ID Admin atau Password salah",response:t.body}),e.next=20;break;case 17:e.prev=17,e.t0=e.catch(0),n(e.t0);case 20:case"end":return e.stop()}}),e,null,[[0,17]])}))),function(e,t,r){return E.apply(this,arguments)}),login:(A=S(regeneratorRuntime.mark((function e(t,r,n){var s,a,o,u,i,c;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(e.prev=0,s=t.body,a=s.nisn,o=s.password,a&&o){e.next=4;break}return e.abrupt("return",r.status(404).json({status:"failed",error:!0,message:"Please provide NISN, or password",response:t.body}));case 4:return e.next=6,O.akun.doc(a).get();case 6:return(u=e.sent).exists||r.status(502).json({status:"error",error:!0,title:"Login Gagal",message:"Akun dengan NISN ini tidak terdaftar",response:t.body}),(i=u.data()).password=i.password||"",e.next=12,b().compare(o,i.password);case 12:e.sent?(c=T(a),t.body.password=void 0,r.cookie("jwt",c,{httpOnly:!0,maxAge:2592e6}),r.status(200).json({status:"success",title:"Login Berhasil",message:"Mengalihkan ke halaman dashboard",error:!1,response:t.body})):r.status(502).json({status:"error",error:!0,title:"Login Gagal",message:"NISN atau Password salah",response:t.body}),e.next=19;break;case 16:e.prev=16,e.t0=e.catch(0),n(e.t0);case 19:case"end":return e.stop()}}),e,null,[[0,16]])}))),function(e,t,r){return A.apply(this,arguments)}),logout:function(e,t){t.cookie("jwt","",{maxAge:1}),t.redirect("/")},retrieveToken:(D=S(regeneratorRuntime.mark((function e(t,r,n){return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:r.status(200).json({status:"success",error:!1,response:t.cookies.jwt});case 1:case"end":return e.stop()}}),e)}))),function(e,t,r){return D.apply(this,arguments)}),uploadFile:(P=S(regeneratorRuntime.mark((function e(t,r,n){var s,a,o;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,s=t.file,a=x.ref("upload/".concat(s.originalname)),e.next=5,a.put(s.buffer);case 5:return e.next=7,a.getDownloadURL();case 7:o=e.sent,r.status(200).json({status:"success",url:o}),e.next=14;break;case 11:e.prev=11,e.t0=e.catch(0),n(e.t0);case 14:case"end":return e.stop()}}),e,null,[[0,11]])}))),function(e,t,r){return P.apply(this,arguments)}),deleteFile:(R=S(regeneratorRuntime.mark((function e(t,r,n){var s,a;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:try{(s=t.body).url,a=s.name,x.ref("upload/".concat(a)).delete(),r.status(200).json({status:"success",error:!1})}catch(e){n(e)}case 1:case"end":return e.stop()}}),e)}))),function(e,t,r){return R.apply(this,arguments)})};var M=l()({storage:l().memoryStorage(),limits:{fileSize:5242880}}),q=t().Router();q.use(i().json()),q.get("/token",N.retrieveToken),q.post("/upload",M.single("avatar"),N.uploadFile),q.post("/delete",N.deleteFile),q.use("/logout",N.logout);const B=q;function G(e){return("function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function C(e,t){return!t||"object"!==G(t)&&"function"!=typeof t?function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e):t}function L(e){var t="function"==typeof Map?new Map:void 0;return function(e){if(null===e||(e,-1===Function.toString.call(r).indexOf("[native code]")))return e;var r;if("function"!=typeof e)throw new TypeError("Super expression must either be null or a function");if(void 0!==t){if(t.has(e))return t.get(e);t.set(e,n)}function n(){return F(e,arguments,X(this).constructor)}return n.prototype=Object.create(e.prototype,{constructor:{value:n,enumerable:!1,writable:!0,configurable:!0}}),Y(n,e)}(e)}function F(e,t,r){return(K()?Reflect.construct:function(e,t,r){var n=[null];n.push.apply(n,t);var s=new(Function.bind.apply(e,n));return r&&Y(s,r.prototype),s}).apply(null,arguments)}function K(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(e){return!1}}function Y(e,t){return(Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function X(e){return(Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}Error;function H(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),r.push.apply(r,n)}return r}function z(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{};t%2?H(Object(r),!0).forEach((function(t){Q(e,t,r[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):H(Object(r)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))}))}return e}function Q(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function U(e,t,r,n,s,a,o){try{var u=e[a](o),i=u.value}catch(e){return void r(e)}u.done?t(i):Promise.resolve(i).then(n,s)}function W(e){return function(){var t=this,r=arguments;return new Promise((function(n,s){var a=e.apply(t,r);function o(e){U(a,n,s,o,u,"next",e)}function u(e){U(a,n,s,o,u,"throw",e)}o(void 0)}))}}const V=function(){for(var e=arguments.length,t=new Array(e),r=0;r<e;r++)t[r]=arguments[r];return function(){var e=W(regeneratorRuntime.mark((function e(r,n,s){return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:try{t.forEach(function(){var e=W(regeneratorRuntime.mark((function e(t){var n;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if("transaksi"!==t){e.next=8;break}return n=j.collection("transaksi"),e.next=4,n.where("nisn","==",r.params.id).get();case 4:e.sent.forEach((function(e){e.ref.delete(),console.log("deleted: ".concat(e.id))})),e.next=10;break;case 8:return e.next=10,t.doc(r.params.id).delete();case 10:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}()),n.status(200).json({status:"success",error:!1,results:"Deleted ".concat(t.length," document")})}catch(e){n.status(502).json({status:"success",error:!0,response:e})}case 1:case"end":return e.stop()}}),e)})));return function(t,r,n){return e.apply(this,arguments)}}()},Z=function(e){return function(){var t=W(regeneratorRuntime.mark((function t(r,n,s){var a,o;return regeneratorRuntime.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.prev=0,t.next=3,e.doc(r.params.id).get();case 3:if((a=t.sent).exists){t.next=7;break}return n.status(401).json({status:"failed",error:!0,message:"No document found with that id",response:r.params}),t.abrupt("return",{success:!1});case 7:return o=a.data(),n.status(200).json(z({status:"success",error:!1},o)),t.abrupt("return",{success:!0});case 12:t.prev=12,t.t0=t.catch(0),n.status(502).json({status:"success",error:!0,response:t.t0});case 15:case"end":return t.stop()}}),t,null,[[0,12]])})));return function(e,r,n){return t.apply(this,arguments)}}()},J=function(e){return function(){var t=W(regeneratorRuntime.mark((function t(r,n,s){var a;return regeneratorRuntime.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.prev=0,a=[],t.next=4,e.get();case 4:if(t.sent.forEach((function(e){a.push(e.data())})),n.status(200).json({status:"success",error:!1,results:a.length,data:a}),!(a.length>0)){t.next=9;break}return t.abrupt("return",{success:!0});case 9:return t.abrupt("return",{success:!1});case 12:t.prev=12,t.t0=t.catch(0),n.status(502).json({status:"success",error:!0,response:t.t0});case 15:case"end":return t.stop()}}),t,null,[[0,12]])})));return function(e,r,n){return t.apply(this,arguments)}}()};function $(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),r.push.apply(r,n)}return r}function ee(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{};t%2?$(Object(r),!0).forEach((function(t){te(e,t,r[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):$(Object(r)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))}))}return e}function te(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function re(e,t,r,n,s,a,o){try{var u=e[a](o),i=u.value}catch(e){return void r(e)}u.done?t(i):Promise.resolve(i).then(n,s)}function ne(e){return function(){var t=this,r=arguments;return new Promise((function(n,s){var a=e.apply(t,r);function o(e){re(a,n,s,o,u,"next",e)}function u(e){re(a,n,s,o,u,"throw",e)}o(void 0)}))}}var se,ae,oe,ue,ie,ce;const pe={getAllSiswaData:J(O.data),getAllAkunSiswa:J(O.akun),getAllProfilSiswa:J(O.profil),getDataSiswa:Z(O.data),getProfilSiswa:Z(O.profil),getAkunSiswa:Z(O.akun),deleteAkunSiswa:V(O.akun,O.profil,"transaksi"),deleteDataSiswa:V(O.akun,O.profil,O.data,"transaksi"),createAkunSiswa:(ce=ne(regeneratorRuntime.mark((function e(t,r,n){var s,a,o,u,i,c;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(e.prev=0,s=t.body,a=s.nisn,o=s.email,u=s.password,a&&o&&u){e.next=4;break}return e.abrupt("return",r.status(404).json({status:"failed",error:!0,title:"Registrasi Gagal",message:"Please provide NISN, Email, or password",response:t.body}));case 4:return i=u,e.next=7,b().hash(i,10);case 7:return c=e.sent,i=c,e.next=11,O.data.doc(a).get();case 11:if(e.sent.exists){e.next=16;break}r.status(401).json({status:"error",error:!0,title:"Registrasi Gagal",message:"NISN tidak valid atau belum terdaftar",response:t.body}),e.next=27;break;case 16:return e.next=18,O.akun.doc(a).get();case 18:if(!e.sent.exists){e.next=23;break}r.status(401).json({status:"error",error:!0,title:"Registrasi Gagal",message:"Akun dengan NISN berikut sudah terdaftar",response:t.body}),e.next=27;break;case 23:return e.next=25,O.akun.doc(a).set({nisn:a,email:o,password:i,saldo:0});case 25:return e.next=27,O.profil.doc(a).set({nisn:a,no_telepon:"",url_foto:""});case 27:t.body.password=void 0,r.status(200).json({status:"success",title:"Registrasi Berhasil",message:"Akun berhasil dibuat",error:!1,response:t.body}),e.next=35;break;case 31:e.prev=31,e.t0=e.catch(0),console.log(e.t0),r.status(502).json({status:"failed",error:!0,response:e.t0});case 35:case"end":return e.stop()}}),e,null,[[0,31]])}))),function(e,t,r){return ce.apply(this,arguments)}),createDataSiswa:(ie=ne(regeneratorRuntime.mark((function e(t,r,n){var s,a,o,u,i;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(e.prev=0,s=t.body,a=s.nisn,o=s.nama,u=s.alamat,i=s.jenis_kelamin,a&&o&&u&&i){e.next=4;break}return e.abrupt("return",r.status(404).json({status:"failed",error:!0,title:"Data Gagal Ditambahkan",message:"Please provide NISN, Name, Address, or Gender",response:t.body}));case 4:return e.next=6,O.data.doc(a).get();case 6:if(!e.sent.exists){e.next=11;break}r.status(401).json({status:"error",error:!0,title:"Data Gagal Ditambahkan",message:"Data dengan NISN berikut sudah ada",response:t.body}),e.next=13;break;case 11:return e.next=13,O.data.doc(a).set({nisn:a,nama:o,alamat:u,jenis_kelamin:i});case 13:return r.status(200).json({status:"success",title:"Data Berhasil Ditambahkan",message:"Tekan tutup untuk menutup popup",error:!1,response:t.body}),e.abrupt("return",ee(ee({},t.body),{},{error:!1}));case 17:e.prev=17,e.t0=e.catch(0),console.log(e.t0),r.status(502).json({status:"failed",error:!0,response:e.t0});case 21:case"end":return e.stop()}}),e,null,[[0,17]])}))),function(e,t,r){return ie.apply(this,arguments)}),createMultipleDataSiswa:(ue=ne(regeneratorRuntime.mark((function e(t,r,n){var s;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(e.prev=0,s=t.body){e.next=4;break}return e.abrupt("return",r.status(404).json({status:"failed",error:!0,title:"Data Gagal Diimpor",message:"Terjadi kesalahan ketika mengimpor berkas",response:t.body}));case 4:return s.forEach(function(){var e=ne(regeneratorRuntime.mark((function e(t){return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,O.data.doc(t.nisn).get();case 2:if(!e.sent.exists){e.next=7;break}console.log("Data exist"),e.next=9;break;case 7:return e.next=9,O.data.doc(t.nisn).set({nisn:t.nisn,nama:t.nama,alamat:t.alamat,jenis_kelamin:t.jenis_kelamin});case 9:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}()),r.status(200).json({status:"success",title:"Data Berhasil Diimpor",message:"Tekan tutup untuk menutup popup",error:!1,response:t.body}),e.abrupt("return",ee(ee({},t.body),{},{error:!1}));case 9:e.prev=9,e.t0=e.catch(0),console.log(e.t0),r.status(502).json({status:"failed",error:!0,response:e.t0});case 13:case"end":return e.stop()}}),e,null,[[0,9]])}))),function(e,t,r){return ue.apply(this,arguments)}),updateAkunSiswa:(oe=ne(regeneratorRuntime.mark((function e(t,r,n){var s,a,o,u,i;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,s=t.params.id,e.next=4,O.akun.doc(s).get();case 4:if((a=e.sent).exists||r.status(401).json({status:"failed",error:!0,message:"Account with this NISN doesn't exist",response:t.body}),t.body.password=t.body.password||"",o=a.data(),""===(u=t.body.password)){e.next=13;break}return e.next=12,b().hash(u,10);case 12:u=e.sent;case 13:return i={email:t.body.email||o.email,password:u||o.password,no_telepon:t.body.no_telepon||o.no_telepon,url_foto:t.body.url_foto||o.url_foto},e.next=16,O.akun.doc(s).update({email:i.email,password:i.password});case 16:return e.next=18,O.profil.doc(s).update({no_telepon:i.no_telepon||"",url_foto:i.url_foto||""});case 18:return t.body.password=void 0,r.status(200).json({status:"success",error:!1,response:t.body}),e.abrupt("return",{success:!0});case 23:e.prev=23,e.t0=e.catch(0),console.log(e.t0),r.status(502).json({status:"failed",error:!0,response:e.t0});case 27:case"end":return e.stop()}}),e,null,[[0,23]])}))),function(e,t,r){return oe.apply(this,arguments)}),updateDataSiswa:(ae=ne(regeneratorRuntime.mark((function e(t,r,n){var s,a,o;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,s=t.params.id,e.next=4,O.data.doc(s).get();case 4:return(a=e.sent).exists||r.status(401).json({status:"failed",error:!0,message:"Data with this NISN doesn't exist",response:t.body}),o=a.data(),e.next=9,O.data.doc(s).update({nama:t.body.nama||o.nama,alamat:t.body.alamat||o.alamat,jenis_kelamin:t.body.jenis_kelamin||o.jenis_kelamin});case 9:return r.status(200).json({status:"success",error:!1,response:t.body}),e.abrupt("return",{success:!0});case 13:e.prev=13,e.t0=e.catch(0),console.log(e.t0),r.status(502).json({status:"failed",error:!0,response:e.t0});case 17:case"end":return e.stop()}}),e,null,[[0,13]])}))),function(e,t,r){return ae.apply(this,arguments)}),updateSaldoSiswa:(se=ne(regeneratorRuntime.mark((function e(t,r,n){var s,a,o,u,i,c,p;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,s=t.params.id,e.next=4,O.akun.doc(s).get();case 4:return(a=e.sent).exists||r.status(401).json({status:"failed",error:!0,message:"Account with this NISN doesn't exist",response:t.body}),o=a.data(),u=t.body,i=u.saldo,c=u.jenis,0,p="pemasukan"===c?+o.saldo+ +i:+o.saldo-+i,e.next=12,O.akun.doc(s).update({saldo:p});case 12:return r.status(200).json({status:"success",error:!1,response:t.body}),e.abrupt("return",{success:!0});case 16:e.prev=16,e.t0=e.catch(0),console.log(e.t0),r.status(502).json({status:"failed",error:!0,response:e.t0});case 20:case"end":return e.stop()}}),e,null,[[0,16]])}))),function(e,t,r){return se.apply(this,arguments)})};var de=t().Router();de.use(i().json()),de.post("/register",pe.createAkunSiswa),de.post("/login",N.login),de.use(N.requireAuth),de.route("/").get(pe.getAllAkunSiswa),de.route("/data").get(pe.getAllSiswaData).post(pe.createDataSiswa),de.route("/data/import").post(pe.createMultipleDataSiswa),de.route("/profil").get(pe.getAllProfilSiswa),de.route("/:id").get(pe.getAkunSiswa).patch(pe.updateAkunSiswa).delete(pe.deleteAkunSiswa),de.route("/:id/profil").get(pe.getProfilSiswa),de.route("/:id/data").get(pe.getDataSiswa).patch(pe.updateDataSiswa).delete(pe.deleteDataSiswa),de.route("/:id/saldo").patch(pe.updateSaldoSiswa);const le=de;function fe(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),r.push.apply(r,n)}return r}function me(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{};t%2?fe(Object(r),!0).forEach((function(t){ge(e,t,r[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):fe(Object(r)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))}))}return e}function ge(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function be(e,t,r,n,s,a,o){try{var u=e[a](o),i=u.value}catch(e){return void r(e)}u.done?t(i):Promise.resolve(i).then(n,s)}function ye(e){return function(){var t=this,r=arguments;return new Promise((function(n,s){var a=e.apply(t,r);function o(e){be(a,n,s,o,u,"next",e)}function u(e){be(a,n,s,o,u,"throw",e)}o(void 0)}))}}var he,ve,we=j.collection("akun_admin");const ke={getAdmin:Z(we),deleteAdmin:V(we),createAdmin:(ve=ye(regeneratorRuntime.mark((function e(t,r,n){var s,a,o,u;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(e.prev=0,s=t.body,a=s.id_admin,o=s.nama,u=s.password,a&&o&&u){e.next=4;break}return e.abrupt("return",r.status(404).json({status:"failed",error:!0,message:"Please provide ID, Name, or password",response:t.body}));case 4:return e.next=6,we.doc(a).get();case 6:return e.sent.exists&&r.status(401).json({status:"failed",error:!0,message:"Account with this ID already exist",response:t.body}),e.next=10,we.akun.doc(a).set({id_admin:a,nama:o,password:u});case 10:return t.body.password=void 0,r.status(200).json({status:"success",error:!1,response:t.body}),e.abrupt("return",me(me({},t.body),{},{error:!1}));case 15:e.prev=15,e.t0=e.catch(0),console.log(e.t0),r.status(502).json({status:"success",error:!0,response:e.t0});case 19:case"end":return e.stop()}}),e,null,[[0,15]])}))),function(e,t,r){return ve.apply(this,arguments)}),updateAdmin:(he=ye(regeneratorRuntime.mark((function e(t,r,n){var s,a,o,u;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,s=t.params.id_admin,e.next=4,we.doc(s).get();case 4:if((a=e.sent).exists||r.status(401).json({status:"failed",error:!0,message:"Account with this ID doesn't exist",response:t.body}),o=a.data(),(u={id_admin:t.body.id_admin||o.id_admin,nama:t.body.nama||o.nama,password:t.body.password||o.password}).email&&u.password){e.next=10;break}return e.abrupt("return",r.status(404).json({status:"failed",error:!0,message:"Please provide Email, or password",response:t.body}));case 10:return e.next=12,we.doc(s).update({id_admin:u.id_admin,nama:u.nama,password:u.password});case 12:return t.body.password=void 0,r.status(200).json({status:"success",error:!1,response:t.body}),e.abrupt("return",{success:!0});case 17:e.prev=17,e.t0=e.catch(0),console.log(e.t0),r.status(502).json({status:"failed",error:!0,response:e.t0});case 21:case"end":return e.stop()}}),e,null,[[0,17]])}))),function(e,t,r){return he.apply(this,arguments)})};var je=t().Router();je.use(i().json()),je.post("/login",N.adminLogin),je.use(N.requireAuth),je.route("/:id").get(ke.getAdmin).patch(ke.updateAdmin).delete(ke.deleteAdmin);const xe=je;function Oe(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),r.push.apply(r,n)}return r}function _e(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{};t%2?Oe(Object(r),!0).forEach((function(t){Se(e,t,r[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):Oe(Object(r)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))}))}return e}function Se(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function Re(e,t,r,n,s,a,o){try{var u=e[a](o),i=u.value}catch(e){return void r(e)}u.done?t(i):Promise.resolve(i).then(n,s)}function Pe(e){return function(){var t=this,r=arguments;return new Promise((function(n,s){var a=e.apply(t,r);function o(e){Re(a,n,s,o,u,"next",e)}function u(e){Re(a,n,s,o,u,"throw",e)}o(void 0)}))}}var De,Ae,Ee,Ie,Te,Ne=j.collection("transaksi");const Me={getTransactionById:Z(Ne),deleteTransactionById:V(Ne),getTransactionByNisn:(Te=Pe(regeneratorRuntime.mark((function e(t,r,n){var s,a;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,Ne.where("nisn","==",t.params.id).get();case 3:return(s=e.sent).empty&&r.status(401).json({status:"failed",error:!0,message:"No transaction found from that user id",response:t.params}),a=[],s.forEach((function(e){a.push(e.data())})),r.status(200).json({status:"success",error:!1,results:a.length,data:a}),e.abrupt("return",{success:!0});case 11:e.prev=11,e.t0=e.catch(0),console.log(e.t0),r.status(502).json({status:"failed",error:!0,response:e.t0});case 15:case"end":return e.stop()}}),e,null,[[0,11]])}))),function(e,t,r){return Te.apply(this,arguments)}),getTransactionByAdmin:(Ie=Pe(regeneratorRuntime.mark((function e(t,r,n){var s,a;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,Ne.where("id_admin","==",t.params.id).get();case 3:return(s=e.sent).empty&&r.status(401).json({status:"failed",error:!0,message:"No transaction found from that admin id",response:t.params}),a=[],s.forEach((function(e){a.push(e.data())})),r.status(200).json({status:"success",error:!1,results:a.length,data:a}),e.abrupt("return",{success:!0});case 11:e.prev=11,e.t0=e.catch(0),console.log(e.t0),r.status(502).json({status:"failed",error:!0,response:e.t0});case 15:case"end":return e.stop()}}),e,null,[[0,11]])}))),function(e,t,r){return Ie.apply(this,arguments)}),createTransaction:(Ee=Pe(regeneratorRuntime.mark((function e(t,r,n){var s,a,o,u,i,c,p,d,l,f,m,g,b,y,h;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(e.prev=0,s=t.body,a=s.nominal,o=s.metode_pembayaran,u=s.jenis_transaksi,i=s.nisn,c=s.id_admin,a&&o&&u&&i){e.next=4;break}return e.abrupt("return",r.status(404).json({status:"failed",error:!0,message:"Something wrong when creating a transaction",response:t.body}));case 4:return p=o[0].toUpperCase(),d="",d="pemasukan"===u?"D":"W",l=[],e.next=10,Ne.get();case 10:for(e.sent.forEach((function(e){l.push(e.data())})),f=[],l.forEach((function(e){f.push(e.id_transaksi)})),m=Math.floor(1e6+9e6*Math.random()),g="T".concat(d+p+m.toString());f.includes(g);)m=Math.floor(1e6+9e6*Math.random()),g="T".concat(d+p+m.toString());return(b=new Date).setDate(b.getDate()+1),y=v.firestore.Timestamp.fromDate(b),h={id_transaksi:g,id_admin:c,nominal:a,metode_pembayaran:o,jenis_transaksi:u,nisn:i,status_transaksi:"pembayaran",tenggat_waktu_pembayaran:y,token:""},e.next=23,Ne.doc(g).set(h);case 23:r.status(200).json({status:"success",error:!1,response:_e({},h)}),e.next=30;break;case 26:e.prev=26,e.t0=e.catch(0),console.log(e.t0),r.status(502).json({status:"failed",error:!0,response:e.t0});case 30:case"end":return e.stop()}}),e,null,[[0,26]])}))),function(e,t,r){return Ee.apply(this,arguments)}),updateTransaction:(Ae=Pe(regeneratorRuntime.mark((function e(t,r,n){var s,a,o,u,i,c,p;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,s=t.body,a=s.id_admin,o=s.token,u=s.status_transaksi,i=t.params.id,e.next=5,Ne.doc(i).get();case 5:return(c=e.sent).exists||r.status(401).json({status:"failed",error:!0,message:"Transaction with this ID doesn't exist",response:t.body}),p=c.data(),e.next=10,Ne.doc(i).update({id_admin:a||p.id_admin,token:o||p.token,status_transaksi:u||p.status_transaksi});case 10:return r.status(200).json({status:"success",error:!1,response:t.body}),e.abrupt("return",{success:!0});case 14:e.prev=14,e.t0=e.catch(0),console.log(e.t0),r.status(502).json({status:"failed",error:!0,response:e.t0});case 18:case"end":return e.stop()}}),e,null,[[0,14]])}))),function(e,t,r){return Ae.apply(this,arguments)}),finishPayment:(De=Pe(regeneratorRuntime.mark((function e(t,r){var n,s,a,o,u,i,c,p;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(e.prev=0,""===(n=t.query.order_id||"")){e.next=21;break}return e.next=5,Ne.doc(n).get();case 5:return s=e.sent,a=s.data(),e.next=9,Ne.doc(n).update({status_transaksi:"selesai"});case 9:return e.next=11,O.akun.doc(a.nisn).get();case 11:return o=e.sent,u=o.data(),i=a.nominal,c=a.jenis_transaksi,0,p="pemasukan"===c?+u.saldo+ +i:+u.saldo-+i,e.next=18,O.akun.doc(a.nisn).update({saldo:p});case 18:r.redirect("/"),e.next=22;break;case 21:r.redirect("/");case 22:e.next=28;break;case 24:e.prev=24,e.t0=e.catch(0),console.log(e.t0),r.status(502).json({status:"failed",error:!0,response:e.t0});case 28:case"end":return e.stop()}}),e,null,[[0,24]])}))),function(e,t){return De.apply(this,arguments)})};var qe=t().Router();qe.use(i().json()),qe.route("/finish").get(Me.finishPayment),qe.route("/create").post(Me.createTransaction),qe.route("/:id").get(Me.getTransactionById).patch(Me.updateTransaction).delete(Me.deleteTransactionById),qe.route("/nisn/:id").get(Me.getTransactionByNisn),qe.route("/admin/:id").get(Me.getTransactionByAdmin);const Be=qe;var Ge=s().join(__dirname,"index.html"),Ce=t()();Ce.use(o()()),Ce.options("*",o()()),Ce.use(p()()),Ce.use(t().json({limit:"15kb"})),Ce.use(i().urlencoded({extended:!0})),Ce.use("/api",B),Ce.use("/api/siswa",le),Ce.use("/api/admin",xe),Ce.use("/api/transaction",Be),Ce.use(t().static(__dirname)),Ce.use("/",(function(e,t){return t.sendFile(Ge)})),Ce.get("*",(function(e,t){t.redirect("/")}));const Le=Ce,Fe={PORT:process.env.PORT||8080,DIST_DIR:__dirname,MIDTRANS_SERVER_KEY:"SB-Mid-server-XmFoI8_j9MpEyaNvbE1-sQiN",MIDTRANS_CLIENT_KEY:"SB-Mid-client-ht5GrRu9A98pjHLR",MIDTRANS_MERCHANT_ID:"G485644100"};Le.listen(Fe.PORT,(function(){console.log("App listening to ".concat(Fe.PORT,"....")),console.log("Press Ctrl+C to quit.")}))})()})();